<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width , initial-scale=1.0" />
    <link rel="stylesheet" href="/css/darkTheme.css">
    <link rel="stylesheet" href="/css/player.css">
    <link rel="stylesheet" href="/css/chart.css">
</head>

<body>
<div class="flexContainer">
    <div><input class="uiCheckbox" id="c1" type="checkbox" store uiID="autoPull" checked="true"> <label for="c1">Auto Pull From Server</label></div>
    <div><input class="uiCheckbox" id="c2" type="checkbox" store uiID="autoPush" checked="true"> <label for="c2">Auto Push To Server</label></div>
    <div><input class="uiCheckbox" id="c3" type="checkbox" store uiID="lockCards"> <label for="c3">Lock Cards</label></div>
    <div><input class="uiCheckbox" id="c4" type="checkbox" store uiID="autoCalc" checked="true"> <label for="c4">Auto Calculate</label></div>
</div>
<div uiID="monster" class="flexContainer">
    <div uiID="deck" class="flexContainer">
        <fieldset uiID="white" class="white flexContainerCol">
            <legend>White</legend>
            <fieldset uiID="discard" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 1s:</div><div class="limitedCounter" sync uiID="1" max="6" points="1">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded{2}s</div><div class="limitedCounter" sync uiID="w" max="3" points="2">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <!-- <label>Reroll Zeros:</label>   <div class="counter" store sync uiID="rerollZeros">0</div> -->
                <label>Draw Cards:</label><div class="counter" store sync uiID="might">0</div>
            </div>
            
        </fieldset>
        <fieldset uiID="yellow" class="yellow flexContainerCol">
            <legend>Yellow</legend>
            <fieldset uiID="discard" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 1s:</div><div class="limitedCounter" sync uiID="1" max="3" points="1">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="3" max="3" points="3">0</div><div>0</div>
                <div>Discarded{3}s</div><div class="limitedCounter" sync uiID="y" max="3" points="3">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <!-- <label>Reroll Zeros:</label>   <div class="counter" store sync uiID="rerollZeros">0</div> -->
                <label>Draw Cards:</label>    <div class="counter" store sync uiID="might">0</div>
            </div>
        </fieldset>
    </div>
    <div uiID="deck" class="flexContainer">
        <fieldset uiID="red" class="red flexContainerCol">
            <legend>Red</legend>
            <fieldset uiID="discard" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="3" max="6" points="3">0</div><div>0</div>
                <div>Discarded{4}s</div><div class="limitedCounter" sync uiID="r" max="3" points="4">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <!-- <label>Reroll Zeros:</label>   <div class="counter" store sync uiID="rerollZeros">0</div> -->
                <label>Draw Cards:</label>    <div class="counter" store sync uiID="might">0</div> 
            </div>
        </fieldset>
        <fieldset uiID="black" class="black flexContainerCol">
            <legend>Black</legend>
            <fieldset uiID="discard"class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="3" max="6" points="3">0</div><div>0</div>
                <div>Discarded 4s:</div><div class="limitedCounter" sync uiID="4" max="3" points="4">0</div><div>0</div>
                <div>Discarded{5}s</div><div class="limitedCounter" sync uiID="b" max="3" points="5">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label><div class="numberResult" uiID="average">0</div> -->
                <!-- <label>Reroll Zeros:</label>   <div class="counter" store sync uiID="rerollZeros">0</div> -->
                <label>Draw Cards:</label>   <div class="counter" store sync uiID="might">0</div>
            </div>
        </fieldset>
    </div>
</div>
<div class="flexContainer">
    <button type="button" id="pushAll" push>Push All</button>
    <button type="button" id="calc" calc>Calculate</button>
    <button type="button" id="pullAll" pull>Pull All</button>
</div>

<div uiID="monster" class="flexContainer">
    <div class="gridContainer" uiID=""><div>Remove Max</div><div class="counter" store uiID="removeMax">0</div></div>
    <div uiID=""><input class="monsterCheckbox" id="c6" type="checkbox" store uiID="rerollZeros"> <label for="c6">Reroll All Zeros</label></div>
    <div class="gridContainer" uiID=""><label>Mob multiplier:</label> <div class="counter" min="1" store uiID="mobMultiplier">1</div></div>
</div>

<div uiID="monster"><input class="monsterCheckbox" id="c7" type="checkbox" store uiID="overlayMaxRemoved"> <label for="c7">Overlay Max Removed</label></div>

</body>

<script type="module">
    import setCalcFn from "/scripts/UI.mjs";
    import {getStoredUIvalue} from "/scripts/storage.mjs"
    import { startWork } from "/scripts/worker.mjs";
    import { probCheckMonster } from "/scripts/monsterProb.mjs";
    import {applyArrayHelperFuncions} from "/scripts/arrayHelpers.mjs"
    import { loadTableGraphic, loadTableList, showTable} from "/scripts/table.mjs";
    applyArrayHelperFuncions();

    function updateUI(prob=[], probMaxRemoved=[]){
        prob = prob.map(w=>w*100);
        probMaxRemoved = probMaxRemoved.map(w=>w*100);
        console.log(prob);
        const chanceAtleast = prob.reversecumsum();
        const chanceAtleastMr = probMaxRemoved.reversecumsum();
        const defense = Array.fromRange(1,18,1); //calculate for defense values between 2 and 10
        const damageProb = defense.map((e)=>{return prob.collectBy((index)=>Math.floor(index/e))});
        const damageProbT = damageProb.map(p=>p.collectBy((index)=>((index < 6)? index : 6)));

        loadTableList("Damage for given Defense",damageProbT, ['defense→ <br> damage⤵', ...defense]);
        if(probMaxRemoved.length>0){
            const damageProbmr = defense.map((e)=>{return probMaxRemoved.collectBy((index)=>Math.floor(index/e))});
            const damageProbTmr = damageProbmr.map(p=>p.collectBy((index)=>((index < 6)? index : 6)));
            loadTableList("Damage for given Defense Max Removed",damageProbTmr, ['defense→ <br> damage⤵', ...defense]);
            showTable("Damage for given Defense Max Removed", true);
        } else {
            showTable("Damage for given Defense Max Removed", false);
        }


        const toPlot = probMaxRemoved.length? {
                exact:[prob,probMaxRemoved], 
                exactHeader:['x','% to get x','max removed'],
                atLeast: [chanceAtleast, chanceAtleastMr],
                atLeastHeader: ['x','% to get x+', 'max removed']
            } : {
                exact:[prob], 
                exactHeader:['x','% to get x'],
                atLeast: [chanceAtleast],
                atLeastHeader: ['x','% to get x+']
            };

        loadTableGraphic("Graph of exactly x", toPlot.exact);
        loadTableGraphic("Graph of at least x", toPlot.atLeast);
        loadTableList("Table of exactly x", toPlot.exact, toPlot.exactHeader);
        loadTableList("Table of at least x or more",toPlot.atLeast, toPlot.atLeastHeader);

        loadTableList("Damage given Defense Full Table",damageProb, ['defense→ <br> damage⤵', ...defense]);
    }

    function monsterCalc(){
        let obj = getStoredUIvalue({monster:undefined});
        console.log('do calcs', obj);
        //cardCopy = {white:{deckCards:[1,1,2,2],discardCards:[1,3],toDraw:1}}
        let cardCopy = obj.deck.map(d=>{
            return {
                deck: d.discard,
                toDraw: d.might*obj.mobMultiplier,
                rerollZeros:d.rerollZeros
            }
        })
        let parameterLists = [[cardCopy, obj.removeMax, obj.rerollZeros]];
        if(obj.overlayMaxRemoved)parameterLists.push([cardCopy, obj.removeMax+1, obj.rerollZeros])
        startWork(probCheckMonster,'scripts/monsterProb.mjs',parameterLists).then(res=> updateUI(...res));
    }

    setCalcFn(monsterCalc);
    monsterCalc();
</script>