<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width , initial-scale=1.0" />
    <link rel="stylesheet" href="css/player.css">
    <link rel="stylesheet" href="css/chart.css">
</head>

<body>
<div class="flexContainer">
    <div><input class="uiCheckbox" id="c1" type="checkbox" store uiID="autoPull" checked="true"> <label for="c1">Auto Pull From Server</label></div>
    <div><input class="uiCheckbox" id="c2" type="checkbox" store uiID="autoPush" checked="true"> <label for="c2">Auto Push To Server</label></div>
    <div><input class="uiCheckbox" id="c3" type="checkbox" store uiID="lockCards"> <label for="c3">Lock Cards</label></div>
    <div><input class="uiCheckbox" id="c4" type="checkbox" store uiID="autoCalc" checked="true"> <label for="c4">Auto Calculate</label></div>
</div>
<div uiID="monster" class="flexContainer">
    <div uiID="" class="flexContainer">
        <fieldset uiID = "white" class="white flexContainerCol">
            <legend>White</legend>
            <fieldset uiID="deck" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 1s:</div><div class="limitedCounter" sync uiID="1" max="6" points="1">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded{2}s</div><div class="limitedCounter" sync uiID="w" max="3" points="2">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <label>Draw:</label><div class="counter" store sync uiID="might">0</div>
            </div>
            
        </fieldset>
        <fieldset uiID = "yellow" class="yellow flexContainerCol">
            <legend>Yellow</legend>
            <fieldset uiID="deck" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 1s:</div><div class="limitedCounter" sync uiID="1" max="3" points="1">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="3" max="3" points="3">0</div><div>0</div>
                <div>Discarded{3}s</div><div class="limitedCounter" sync uiID="y" max="3" points="3">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <label>Draw:</label>    <div class="counter" store sync uiID="might">0</div>
            </div>
        </fieldset>
    </div>
    <div uiID="" class="flexContainer">
        <fieldset uiID = "red" class="red flexContainerCol">
            <legend>Red</legend>
            <fieldset uiID="deck" class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 2s:</div><div class="limitedCounter" sync uiID="2" max="3" points="2">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="3" max="6" points="3">0</div><div>0</div>
                <div>Discarded{4}s</div><div class="limitedCounter" sync uiID="r" max="3" points="4">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label> <div>0</div> -->
                <label>Draw:</label>    <div class="counter" store sync uiID="might">0</div> 
            </div>
        </fieldset>
        <fieldset uiID = "black" class="black flexContainerCol">
            <legend>Black</legend>
            <fieldset uiID="deck"class="subgrid">
                <legend>Deck <button type="button" reset>Reset</button> <button type="button" push>Push</button> <button type="button" pull>Pull</button></legend>
                <div>Discarded 0s:</div><div class="limitedCounter" sync uiID="0" max="6" points="0">0</div><div>0</div>
                <div>Discarded 3s:</div><div class="limitedCounter" sync uiID="1" max="6" points="3">0</div><div>0</div>
                <div>Discarded 4s:</div><div class="limitedCounter" sync uiID="2" max="3" points="4">0</div><div>0</div>
                <div>Discarded{5}s</div><div class="limitedCounter" sync uiID="b" max="3" points="5">0</div><div>0</div>
            </fieldset>
            <div class="gridContainer" uiID="">
                <!-- <label>Deck Average:</label><div class="numberResult" uiID="average">0</div> -->
                <label>Draw:</label>   <div class="counter" store sync uiID="might">0</div>
            </div>
        </fieldset>
    </div>
</div>
<div class="flexContainer">
    <button type="button" id="pushAll" push>Push All</button>
    <button type="button" id="calc" calc>Calculate</button>
    <button type="button" id="pullAll" pull>Pull All</button>
</div>

<div uiID="monster" class="flexContainer">
    <div uiID=""><input class="monsterCheckbox" id="c5" type="checkbox" store uiID="removeMax"> <label for="c5">Remove Max Value</label></div>
    <div uiID=""><input class="monsterCheckbox" id="c6" type="checkbox" store uiID="rerollZeros"> <label for="c6">Reroll All Zeros</label></div>
    <div class="gridContainer" uiID=""><label>Mob multiplier:</label> <div class="counter" min="1" store uiID="mobMultiplier">1</div></div>
</div>
</body>

<script type="module">
    import setCalcFn from "/scripts/UI.mjs";
    import {getStoredUIvalue} from "/scripts/storage.mjs"
    import { startWork } from "/scripts/worker.mjs";
    import { probCheckMonster } from "/scripts/monsterProb.mjs";
    import {applyArrayHelperFuncions} from "/scripts/arrayHelpers.mjs"
    import { loadTableGraphic, loadTableList} from "/scripts/table.mjs";
    applyArrayHelperFuncions();

    function updateUI(prob){
        let chanceAtleast = prob.reversecumsum();

        loadTableGraphic("Graph of exactly x", [prob],true);
        loadTableGraphic("Graph of at least x", [chanceAtleast], false);
        loadTableList("Table of exactly x",[prob], ['x','% to get x'], false);
        loadTableList("Table of at least x or more",[chanceAtleast], ['x','% to get x+'], false);

        let defense = Array.fromRange(1,18,1); //calculate for defense values between 2 and 10
        let damageProb = defense.map((e)=>{return prob.collectBy((index)=>Math.floor(index/e))});
        let damageProbT = damageProb.map(p=>p.collectBy((index)=>((index < 6)? index : 6)));

        loadTableList("Damage for given Defense",damageProbT, ['defense→ <br> damage⤵', ...defense],true);
        loadTableList("Damage given Defense<br>Full Table",damageProb, ['defense→ <br> damage⤵', ...defense],false);
    }

    function monsterCalc(){
        let obj = getStoredUIvalue({monster:undefined});
        console.log('do calcs', obj);
        //cardCopy = {white:{deckCards:[1,1,2,2],discardCards:[1,3],toDraw:1}}
        let cardCopy = obj.map(d=>{
            let deckCards = [];
            let discardCards = [];
            for(const prop in d.deck){
                let c = d.deck[prop];
                deckCards = deckCards.concat(Array(c.max-c.discarded).fill(c.points));
                discardCards = discardCards.concat(Array(c.discarded).fill(c.points));
            }
            return {
                deckCards,
                discardCards,
                toDraw: d.might*obj.mobMultiplier
            }
        })
        startWork(probCheckMonster,'scripts/monsterProb.mjs',[cardCopy,obj.removeMax,obj.rerollZeros], updateUI);
    }

    setCalcFn(monsterCalc);
    monsterCalc();
</script>